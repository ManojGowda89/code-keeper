<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Keeper</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --transition: all 0.3s ease;
    }
    
    body {
      background-color: #f5f7fb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .app-header {
      background-color: var(--primary);
      color: white;
      padding: 1.5rem 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .navbar {
      background-color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 0.75rem 1rem;
      margin-bottom: 1.5rem;
    }
    
    .navbar-nav .nav-link {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: var(--transition);
    }
    
    .navbar-nav .nav-link.active {
      background-color: var(--success);
      color: var(--dark);
    }
    
    .form-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .snippet {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: var(--transition);
    }
    
    .snippet:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .code-container {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    pre {
      margin: 0;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    
    .copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.375rem 0.625rem;
      font-size: 0.75rem;
      z-index: 10;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .copy-btn:hover {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .editing-active {
      background-color: #f0f7ff;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
    }
    
    .edit-form textarea {
      min-height: 200px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.875rem;
      line-height: 1.5;
      resize: vertical;
    }
    
    .edit-status-bar {
      background-color: var(--warning);
      color: var(--dark);
      text-align: center;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      font-weight: 500;
      display: none;
    }
    
    .edit-status-bar.active {
      display: block;
    }
    
    .toast-container {
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      z-index: 1100;
    }
    
    .app-toast {
      transition: var(--transition);
      transform: translateY(100px);
      opacity: 0;
    }
    
    .app-toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .app-footer {
      margin-top: auto;
      padding: 1.25rem 0;
      background-color: white;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 575.98px) {
      .snippet {
        padding: 1rem;
      }
      
      .form-container {
        padding: 1rem;
      }
      
      .btn-sm-block {
        display: block;
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      .snippet-actions .btn {
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container text-center">
      <h1 class="mb-0"><i class="fas fa-folder me-2"></i>Code Keeper</h1>
    </div>
  </header>

  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarContent">
        <ul class="navbar-nav me-auto">
          <li class="nav-item me-2">
            <a id="viewCodeBtn" class="nav-link active" href="javascript:void(0)" onclick="showCodeList()">
              <i class="fas fa-list me-1"></i> Code
            </a>
          </li>
          <li class="nav-item">
            <a id="addCodeBtn" class="nav-link" href="javascript:void(0)" onclick="showAddForm()">
              <i class="fas fa-plus me-1"></i> Add Code
            </a>
          </li>
        </ul>
        
        <div id="searchContainer" class="d-flex ms-auto">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="search" class="form-control" placeholder="Search by title or description (regex allowed)">
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Add Form Section -->
    <div id="formSection" class="form-container hidden">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="form-title" class="mb-0">Add New Snippet</h2>
      </div>
      <input type="hidden" id="snippetId" />
      
      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <input type="text" class="form-control" id="title" placeholder="Enter a descriptive title" required />
      </div>
      
      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <input type="text" class="form-control" id="description" placeholder="Brief description of what this code does" required />
      </div>
      
      <div class="mb-4">
        <label for="code" class="form-label">Code</label>
        <textarea class="form-control" id="code" rows="8" placeholder="Paste your code here..." required></textarea>
      </div>
      
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" onclick="saveSnippet()" id="saveBtn">
          <i class="fas fa-save me-1"></i> Save Snippet
        </button>
        <button class="btn btn-secondary" onclick="cancelForm()">
          <i class="fas fa-times me-1"></i> Cancel
        </button>
      </div>
    </div>

    <!-- Snippets List Section -->
    <div id="snippetsSection">
      <div id="edit-status-indicator" class="edit-status-bar">
        <i class="fas fa-info-circle me-1"></i> You are currently editing a snippet. Search is temporarily disabled.
      </div>
      <div id="snippets" class="snippets-container"></div>
    </div>
  </div>

  <div class="toast-container">
    <div id="toast" class="app-toast bg-dark text-white p-3 rounded"></div>
  </div>

  <footer class="app-footer text-center text-muted">
    <div class="container">
      <small>Last updated: 2025-08-25 08:50:22 UTC | User: ManojGowda89</small>
    </div>
  </footer>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = "/api/snippets";
    let searchTimeout = null;
    let isAnySnippetBeingEdited = false;
    let activeEditId = null;

    // Debounce function to delay search execution
    function debounce(func, delay) {
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          func.apply(context, args);
        }, delay);
      };
    }

    // Show toast notification
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Switch to code list view
    function showCodeList() {
      // Only allow switching to code list if not in edit mode
      if (isAnySnippetBeingEdited) {
        showToast('Please save or cancel your edits first');
        return;
      }
      
      // Hide add form, show snippets list
      document.getElementById('formSection').classList.add('hidden');
      document.getElementById('snippetsSection').classList.remove('hidden');
      
      // Update nav buttons
      document.getElementById('viewCodeBtn').classList.add('active');
      document.getElementById('addCodeBtn').classList.remove('active');
      
      // Show search
      document.getElementById('searchContainer').classList.remove('d-none');
      
      // Load snippets
      fetchSnippets();
    }

    // Switch to add form view
    function showAddForm() {
      // Only allow switching to add form if not in edit mode
      if (isAnySnippetBeingEdited) {
        showToast('Please save or cancel your edits first');
        return;
      }
      
      // Show add form, hide snippets list
      document.getElementById('formSection').classList.remove('hidden');
      document.getElementById('snippetsSection').classList.add('hidden');
      
      // Update nav buttons
      document.getElementById('viewCodeBtn').classList.remove('active');
      document.getElementById('addCodeBtn').classList.add('active');
      
      // Hide search
      document.getElementById('searchContainer').classList.add('d-none');
      
      // Reset form
      resetForm();
    }

    function cancelForm() {
      resetForm();
      showCodeList();
    }

    // Fetch and display snippets
    async function fetchSnippets() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const container = document.getElementById("snippets");
        container.innerHTML = "";

        const query = document.getElementById("search").value.trim();
        let regex;
        try { regex = query ? new RegExp(query, "i") : null; } catch { regex = null; }

        if (data.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info text-center">
              No snippets found. Add your first code snippet above!
            </div>`;
          return;
        }

        const filteredData = regex 
          ? data.filter(snippet => regex.test(snippet.title) || regex.test(snippet.description))
          : data;
          
        if (filteredData.length === 0) {
          container.innerHTML = `
            <div class="alert alert-info text-center">
              No snippets match your search.
            </div>`;
          return;
        }

        filteredData.forEach(snippet => {
          const encodedCode = encodeURIComponent(snippet.code);
          
          container.innerHTML += `
            <div class="snippet" id="snippet-${snippet.id}">
              <!-- View Mode -->
              <div class="view-mode" id="view-${snippet.id}">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h3 class="h5 mb-0">${escapeHtml(snippet.title)}</h3>
                </div>
                <p class="text-muted mb-3">${escapeHtml(snippet.description)}</p>
                <div class="code-container mb-3">
                  <button class="copy-btn" onclick="copyCode('${encodedCode}', this)">
                    <i class="fas fa-copy me-1"></i> Copy
                  </button>
                  <pre><code class="code-block">${escapeHtml(snippet.code)}</code></pre>
                </div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-warning btn-sm" onclick="toggleEditMode(${snippet.id})">
                    <i class="fas fa-edit me-1"></i> Edit
                  </button>
                  <button class="btn btn-danger btn-sm" onclick="deleteSnippet(${snippet.id})">
                    <i class="fas fa-trash-alt me-1"></i> Delete
                  </button>
                </div>
              </div>
              
              <!-- Edit Mode (hidden by default) -->
              <div class="edit-form hidden" id="edit-${snippet.id}">
                <div class="mb-3">
                  <label for="edit-title-${snippet.id}" class="form-label">Title</label>
                  <input type="text" class="form-control" id="edit-title-${snippet.id}" value="${escapeHtml(snippet.title)}" placeholder="Title" required />
                </div>
                <div class="mb-3">
                  <label for="edit-description-${snippet.id}" class="form-label">Description</label>
                  <input type="text" class="form-control" id="edit-description-${snippet.id}" value="${escapeHtml(snippet.description)}" placeholder="Description" required />
                </div>
                <div class="mb-3">
                  <label for="edit-code-${snippet.id}" class="form-label">Code</label>
                  <textarea class="form-control" id="edit-code-${snippet.id}" rows="10" placeholder="Your code here..." required>${escapeHtml(snippet.code)}</textarea>
                </div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-primary btn-sm" onclick="updateSnippet(${snippet.id})">
                    <i class="fas fa-check me-1"></i> Save Changes
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="cancelEditMode(${snippet.id})">
                    <i class="fas fa-times me-1"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
          `;
        });

        // Apply syntax highlighting
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      } catch (error) {
        console.error('Error fetching snippets:', error);
        showToast('Error loading snippets. Please try again.');
      }
    }

    // Toggle edit mode for a specific snippet
    function toggleEditMode(id) {
      // If another snippet is already being edited, prevent this one from opening
      if (isAnySnippetBeingEdited && activeEditId !== id) {
        showToast('Please save or cancel your current edits first');
        return;
      }
      
      const snippetElement = document.getElementById(`snippet-${id}`);
      const viewMode = document.getElementById(`view-${id}`);
      const editMode = document.getElementById(`edit-${id}`);
      
      // Toggle visibility
      if (viewMode.classList.contains('hidden')) {
        // Switch back to view mode
        viewMode.classList.remove('hidden');
        editMode.classList.add('hidden');
        snippetElement.classList.remove('editing-active');
        isAnySnippetBeingEdited = false;
        activeEditId = null;
      } else {
        // Switch to edit mode
        viewMode.classList.add('hidden');
        editMode.classList.remove('hidden');
        snippetElement.classList.add('editing-active');
        isAnySnippetBeingEdited = true;
        activeEditId = id;
      }
      
      // Update UI state based on edit mode
      if (isAnySnippetBeingEdited) {
        // Hide search and show notification when editing
        document.getElementById('searchContainer').classList.add('d-none');
        document.getElementById('edit-status-indicator').classList.add('active');
        
        // Scroll to the snippet being edited
        snippetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Automatically focus on the title field
        document.getElementById(`edit-title-${id}`).focus();
      } else {
        // Show search and hide notification when not editing
        document.getElementById('searchContainer').classList.remove('d-none');
        document.getElementById('edit-status-indicator').classList.remove('active');
      }
      
      // Adjust textarea height based on content
      const codeTextarea = document.getElementById(`edit-code-${id}`);
      if (codeTextarea && !editMode.classList.contains('hidden')) {
        codeTextarea.style.height = "auto";
        codeTextarea.style.height = (codeTextarea.scrollHeight + 5) + "px";
      }
    }
    
    // Cancel edit mode for a specific snippet
    function cancelEditMode(id) {
      const snippetElement = document.getElementById(`snippet-${id}`);
      const viewMode = document.getElementById(`view-${id}`);
      const editMode = document.getElementById(`edit-${id}`);
      
      // Exit edit mode
      viewMode.classList.remove('hidden');
      editMode.classList.add('hidden');
      snippetElement.classList.remove('editing-active');
      
      // Update global editing state
      isAnySnippetBeingEdited = false;
      activeEditId = null;
      
      // Show search and hide notification
      document.getElementById('searchContainer').classList.remove('d-none');
      document.getElementById('edit-status-indicator').classList.remove('active');
    }

    // Save new snippet
    async function saveSnippet() {
      const id = document.getElementById("snippetId").value;
      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const code = document.getElementById("code").value;

      if (!title || !description || !code) {
        showToast("All fields are required");
        return;
      }

      try {
        const method = id ? "PUT" : "POST";
        const url = id ? `${API_URL}/${id}` : API_URL;

        const response = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, description, code })
        });

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        resetForm();
        showCodeList();
        showToast(id ? "Snippet updated successfully" : "Snippet added successfully");
      } catch (error) {
        console.error('Error saving snippet:', error);
        showToast('Error saving snippet. Please try again.');
      }
    }

    // Update existing snippet
    async function updateSnippet(id) {
      const title = document.getElementById(`edit-title-${id}`).value;
      const description = document.getElementById(`edit-description-${id}`).value;
      const code = document.getElementById(`edit-code-${id}`).value;

      if (!title || !description || !code) {
        showToast("All fields are required");
        return;
      }

      try {
        const response = await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, description, code })
        });

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }

        // Update global editing state
        isAnySnippetBeingEdited = false;
        activeEditId = null;
        
        // Show search and hide notification
        document.getElementById('searchContainer').classList.remove('d-none');
        document.getElementById('edit-status-indicator').classList.remove('active');
        
        fetchSnippets();
        showToast("Snippet updated successfully");
      } catch (error) {
        console.error('Error updating snippet:', error);
        showToast('Error updating snippet. Please try again.');
      }
    }

    // Delete snippet
    async function deleteSnippet(id) {
      if (!confirm("Are you sure you want to delete this snippet?")) return;
      
      try {
        const response = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }
        
        fetchSnippets();
        showToast("Snippet deleted successfully");
      } catch (error) {
        console.error('Error deleting snippet:', error);
        showToast('Error deleting snippet. Please try again.');
      }
    }

    // Reset form fields
    function resetForm() {
      document.getElementById("snippetId").value = "";
      document.getElementById("title").value = "";
      document.getElementById("description").value = "";
      document.getElementById("code").value = "";
      document.getElementById("form-title").innerText = "Add New Snippet";
      document.getElementById("saveBtn").innerHTML = `
        <i class="fas fa-save me-1"></i> Save Snippet
      `;
    }

    // Copy code to clipboard
    function copyCode(encodedCode, button) {
      const code = decodeURIComponent(encodedCode);
      navigator.clipboard.writeText(code);
      
      // Visual feedback
      const originalText = button.innerHTML;
      button.innerHTML = `
        <i class="fas fa-check me-1"></i> Copied!
      `;
      
      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    }

    // Helper function to escape HTML
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Adjust textarea height based on content
    function autoResizeTextarea(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = (textarea.scrollHeight) + "px";
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set up debounced search
      const debouncedSearch = debounce(fetchSnippets, 500);
      document.getElementById('search').addEventListener('input', debouncedSearch);
      
      showCodeList(); // Default to showing code list
      
      // Add event listener for auto-resizing textareas
      document.addEventListener('input', function(e) {
        if (e.target.tagName.toLowerCase() === 'textarea') {
          autoResizeTextarea(e.target);
        }
      });
    });
  </script>
</body>
</html>